_context.invoke("Nittro.Ajax",function(Nittro,Url,undefined){var FormData=Nittro.Forms?Nittro.Forms.FormData:null,Request=_context.extend("Nittro.Object",function(url,method,data){this._={url:Url.from(url),method:(method||"GET").toUpperCase(),data:data||{},headers:{},normalized:!1,promise:null,abort:null,aborted:!1}},{getUrl:function(){return this._normalize(),this._.url},getMethod:function(){return this._.method},isGet:function(){return"GET"===this._.method},isPost:function(){return"POST"===this._.method},isMethod:function(method){return method.toUpperCase()===this._.method},getData:function(){return this._normalize(),this._.data},getHeaders:function(){return this._.headers},setUrl:function(url){return this._updating("url"),this._.url=Url.from(url),this},setMethod:function(method){return this._updating("method"),this._.method=method.toLowerCase(),this},setData:function(k,v){if(this._updating("data"),null===k)this._.data={};else if(v===undefined&&"object"==typeof k)for(v in k)k.hasOwnProperty(v)&&(this._.data[v]=k[v]);else this._.data[k]=v;return this},setHeader:function(header,value){return this._updating("headers"),this._.headers[header]=value,this},setHeaders:function(headers){this._updating("headers");for(var header in headers)headers.hasOwnProperty(header)&&(this._.headers[header]=headers[header]);return this},setDispatched:function(promise,abort){if(!(promise instanceof Promise))throw new Error('"promise" must be an instance of Promise');if("function"!=typeof abort)throw new Error('"abort" must be a function');return this._.promise=promise,this._.abort=abort,this},isDispatched:function(){return!!this._.promise},then:function(onfulfilled,onrejected){return this._.promise.then(onfulfilled,onrejected)},abort:function(){return this._.abort&&!this._.aborted&&this._.abort(),this._.aborted=!0,this},isAborted:function(){return this._.aborted},_normalize:function(){!this._.normalized&&this.isFrozen()&&(this._.normalized=!0,"GET"!==this._.method&&"HEAD"!==this._.method||(this._.url.addParams(FormData&&this._.data instanceof FormData?this._.data.exportData(!0):this._.data),this._.data={}))}});_context.mixin(Request,"Nittro.Freezable"),_context.register(Request,"Request")},{Url:"Utils.Url"}),_context.invoke("Nittro.Ajax",function(){var Response=_context.extend(function(status,payload,headers){this._={status:status,payload:payload,headers:headers}},{getStatus:function(){return this._.status},getPayload:function(){return this._.payload},getHeader:function(name){return this._.headers[name.toLowerCase()]},getAllHeaders:function(){return this._.headers}});_context.register(Response,"Response")}),_context.invoke("Nittro.Ajax",function(Request){var Service=_context.extend("Nittro.Object",function(){Service.Super.call(this),this._.transports=[]},{addTransport:function(transport){return this._.transports.push(transport),this},get:function(url,data){return this.dispatch(this.createRequest(url,"get",data))},post:function(url,data){return this.dispatch(this.createRequest(url,"post",data))},createRequest:function(url,method,data){var request=new Request(url,method,data);return this.trigger("request-created",{request:request}),request},dispatch:function(request){request.freeze();for(var i=0;i<this._.transports.length;i++)try{return this._.transports[i].dispatch(request)}catch(e){console.log(e)}throw new Error("No transport is able to dispatch this request")}});_context.register(Service,"Service")}),_context.invoke("Nittro.Ajax.Transport",function(Nittro,Response,Url){var FormData=Nittro.Forms?Nittro.Forms.FormData:null,Native=_context.extend(function(){},{STATIC:{createXhr:function(){if(window.XMLHttpRequest)return new XMLHttpRequest;if(window.ActiveXObject)try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){return new ActiveXObject("Microsoft.XMLHTTP")}}},dispatch:function(request){var xhr=Native.createXhr(),adv=this.checkSupport(xhr),abort=xhr.abort.bind(xhr),promise=new Promise(function(fulfill,reject){request.isAborted()&&reject(this._createError(xhr,{type:"abort"})),this._bindEvents(request,xhr,adv,fulfill,reject),xhr.open(request.getMethod(),request.getUrl().toAbsolute(),!0);var data=this._formatData(request,xhr);this._addHeaders(request,xhr),xhr.send(data)}.bind(this));return request.setDispatched(promise,abort),promise},checkSupport:function(xhr){var adv;if(!((adv="addEventListener"in xhr)||"onreadystatechange"in xhr))throw new Error("Unsupported XHR implementation");return adv},_bindEvents:function(request,xhr,adv,fulfill,reject){function onLoad(evt){xhr.status>=200&&xhr.status<300?fulfill(self._createResponse(xhr)):reject(self._createError(xhr,evt))}function onError(evt){reject(self._createError(xhr,evt))}function onProgress(evt){request.trigger("progress",{lengthComputable:evt.lengthComputable,loaded:evt.loaded,total:evt.total})}var self=this;adv?(xhr.addEventListener("load",onLoad,!1),xhr.addEventListener("error",onError,!1),xhr.addEventListener("abort",onError,!1),"upload"in xhr&&xhr.upload.addEventListener("progress",onProgress,!1)):(xhr.onreadystatechange=function(){4===xhr.readyState&&(xhr.status>=200&&xhr.status<300?onLoad():onError())},"ontimeout"in xhr&&(xhr.ontimeout=onError),"onerror"in xhr&&(xhr.onerror=onError),"onload"in xhr&&(xhr.onload=onLoad))},_addHeaders:function(request,xhr){var h,headers=request.getHeaders();for(h in headers)headers.hasOwnProperty(h)&&xhr.setRequestHeader(h,headers[h]);headers.hasOwnProperty("X-Requested-With")||xhr.setRequestHeader("X-Requested-With","XMLHttpRequest")},_formatData:function(request,xhr){var data=request.getData();return FormData&&data instanceof FormData?(data=data.exportData(request.isGet()||request.isMethod("HEAD")),data instanceof window.FormData||(data=Url.buildQuery(data,!0),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"))):(data=Url.buildQuery(data),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded")),data},_createResponse:function(xhr){var payload,headers={};return(xhr.getAllResponseHeaders()||"").trim().split(/\r\n/g).forEach(function(header){header&&!header.match(/^\s+$/)&&(header=header.match(/^\s*([^:]+):\s*(.+)\s*$/),headers[header[1].toLowerCase()]=header[2])}),payload=headers["content-type"]&&"application/json"===headers["content-type"].split(/;/)[0]?JSON.parse(xhr.responseText||"{}"):xhr.responseText,new Response(xhr.status,payload,headers)},_createError:function(xhr,evt){var response=null;return 4===xhr.readyState&&0!==xhr.status&&(response=this._createResponse(xhr)),evt&&"abort"===evt.type?{type:"abort",status:null,response:response}:0===xhr.status?{type:"connection",status:null,response:response}:xhr.status<200||xhr.status>=300?{type:"response",status:xhr.status,response:response}:{type:"unknown",status:xhr.status,response:response}}});_context.register(Native,"Native")},{Url:"Utils.Url",Response:"Nittro.Ajax.Response"}),_context.invoke("Nittro.Ajax.Bridges",function(Nittro){if(Nittro.DI){var AjaxDI=_context.extend("Nittro.DI.BuilderExtension",function(containerBuilder,config){AjaxDI.Super.call(this,containerBuilder,config)},{load:function(){var builder=this._getContainerBuilder();builder.addServiceDefinition("ajax",{factory:"Nittro.Ajax.Service()",run:!0,setup:["::addTransport(Nittro.Ajax.Transport.Native())"]})}});_context.register(AjaxDI,"AjaxDI")}});